#!/bin/bash
# æœåŠ¡è¯Šæ–­è„šæœ¬ - åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” æœåŠ¡è¯Šæ–­æŠ¥å‘Š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "1. PM2 æœåŠ¡çŠ¶æ€ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
pm2 status | grep ai-tools-backend || echo "âŒ æœåŠ¡æœªè¿è¡Œ"
echo ""

echo "2. ç«¯å£ç›‘å¬æƒ…å†µï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if netstat -tlnp 2>/dev/null | grep :3001 > /dev/null; then
    echo "âœ… ç«¯å£ 3001 æ­£åœ¨ç›‘å¬"
    netstat -tlnp 2>/dev/null | grep :3001
elif ss -tlnp 2>/dev/null | grep :3001 > /dev/null; then
    echo "âœ… ç«¯å£ 3001 æ­£åœ¨ç›‘å¬"
    ss -tlnp 2>/dev/null | grep :3001
else
    echo "âŒ ç«¯å£ 3001 æœªç›‘å¬"
fi
echo ""

echo "3. æµ‹è¯•æœ¬åœ° APIï¼ˆæœ€é‡è¦ï¼‰ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
LOCAL_TEST=$(curl -s -w "\nHTTP_CODE:%{http_code}" http://localhost:3001/app/api/courses 2>&1)
HTTP_CODE=$(echo "$LOCAL_TEST" | grep "HTTP_CODE" | cut -d: -f2)
BODY=$(echo "$LOCAL_TEST" | grep -v "HTTP_CODE")
echo "HTTP çŠ¶æ€ç : $HTTP_CODE"
if [ "$HTTP_CODE" = "200" ]; then
    echo "âœ… æœ¬åœ° API æ­£å¸¸"
    echo "å“åº”å†…å®¹ï¼ˆå‰3è¡Œï¼‰ï¼š"
    echo "$BODY" | head -3
else
    echo "âŒ æœ¬åœ° API è¿”å›é”™è¯¯"
    echo "å“åº”å†…å®¹ï¼š"
    echo "$BODY" | head -10
fi
echo ""

echo "4. å¥åº·æ£€æŸ¥ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
HEALTH=$(curl -s http://localhost:3001/health 2>&1)
if [ $? -eq 0 ]; then
    echo "âœ… å¥åº·æ£€æŸ¥å“åº”ï¼š"
    echo "$HEALTH" | head -5
else
    echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
    echo "$HEALTH"
fi
echo ""

echo "5. PM2 é”™è¯¯æ—¥å¿—ï¼ˆæœ€è¿‘30è¡Œï¼‰ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
pm2 logs ai-tools-backend --err --lines 30 --nostream 2>/dev/null | tail -30 || echo "æ— é”™è¯¯æ—¥å¿—"
echo ""

echo "6. PM2 è¾“å‡ºæ—¥å¿—ï¼ˆæœ€è¿‘20è¡Œï¼‰ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
pm2 logs ai-tools-backend --out --lines 20 --nostream 2>/dev/null | tail -20 || echo "æ— è¾“å‡ºæ—¥å¿—"
echo ""

echo "7. è¿›ç¨‹å†…å­˜ä½¿ç”¨ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
pm2 describe ai-tools-backend 2>/dev/null | grep -E "memory|cpu|restarts|uptime" || echo "æ— æ³•è·å–è¿›ç¨‹ä¿¡æ¯"
echo ""

echo "8. æ£€æŸ¥æ•°æ®åº“è¿æ¥ï¼ˆå¦‚æœå¯èƒ½ï¼‰ï¼š"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
# å°è¯•ä»æ—¥å¿—ä¸­æŸ¥æ‰¾æ•°æ®åº“ç›¸å…³é”™è¯¯
pm2 logs ai-tools-backend --err --lines 50 --nostream 2>/dev/null | grep -i "database\|mysql\|connection" | tail -5 || echo "æœªå‘ç°æ•°æ®åº“ç›¸å…³é”™è¯¯"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "è¯Šæ–­å®Œæˆ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

